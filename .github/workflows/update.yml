name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  workflow_dispatch:


jobs:
  main:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: pwsh

    steps:
    - uses: actions/checkout@v4

    - name: Get and Handle content
      run: |
        #!/usr/bin/pwsh
        wget -O modules-raw.json https://github.com/Magisk-Modules-Alt-Repo/json/raw/refs/heads/main/modules.json
        $content = Get-Content modules-raw.json
        $content -replace "https://raw.githubusercontent.com/", "https://ghproxy.net/raw.githubusercontent.com/" -replace "https://github.com/", "https://ghproxy.net/github.com/"  | Set-Content modules.json

    - name: Set Git Info & Check Git config
      run: |
        #!/usr/bin/pwsh
        git config --global user.email "qzlin01@163.com"
        git config --global user.name "QZLin"
        git config --global --unset core.repositoryformatversion
        git config --list

    - name: Setup SSH
      env:
        KEY_BOT: ${{ secrets.BOT_SSH_KEY }}
      run: |
        #!/usr/bin/pwsh
        . .github/workflows/key.ps1
        ssh-keyscan github.com >> ~/.ssh/known_hosts

    - name: commit
      run: |
        #!/usr/bin/pwsh
        git commit -am 'update'
        git branch -M main
        git push --force "git@github.com:${{ github.GITHUB_REPOSITORY }}.git"
